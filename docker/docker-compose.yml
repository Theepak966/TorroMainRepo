version: '3.8'

services:
  mysql:
    image: mysql:8.0
    container_name: torro-mysql
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD:-rootpassword}
      MYSQL_DATABASE: torroforairflow
    ports:
      - "3307:3306"
    volumes:
      - mysql_data:/var/lib/mysql
      - ../database/schema.sql:/docker-entrypoint-initdb.d/01-schema.sql
      - ../database/lineage_schema.sql:/docker-entrypoint-initdb.d/02-lineage-schema.sql
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      interval: 10s
      timeout: 5s
      retries: 5

  backend:
    build:
      context: ../backend
      dockerfile: ../docker/Dockerfile.backend
    container_name: torro-backend
    ports:
      - "8099:8099"
    environment:
      - FLASK_ENV=production
      - FLASK_HOST=0.0.0.0
      - FLASK_PORT=8099
      - DB_HOST=mysql
      - DB_PORT=3306
      - DB_USER=root
      - DB_PASSWORD=${MYSQL_ROOT_PASSWORD:-rootpassword}
      - DB_NAME=torroforairflow
      - AIRFLOW_BASE_URL=http://airflow-webserver:8080
      - AIRFLOW_USER=airflow
      - AIRFLOW_PASSWORD=airflow
    volumes:
      - ../backend:/app
    depends_on:
      mysql:
        condition: service_healthy
    restart: unless-stopped

  airflow-webserver:
    build:
      context: ../airflow
      dockerfile: ../docker/Dockerfile.airflow
    container_name: torro-airflow-webserver
    command: webserver
    ports:
      - "8080:8080"
    environment:
      - AIRFLOW__CORE__EXECUTOR=LocalExecutor
      - AIRFLOW__DATABASE__SQL_ALCHEMY_CONN=mysql+pymysql://root:${MYSQL_ROOT_PASSWORD:-rootpassword}@mysql:3306/torroforairflow
      - AIRFLOW__CORE__FERNET_KEY=${AIRFLOW_FERNET_KEY:-}
      - AIRFLOW__CORE__DAGS_ARE_PAUSED_AT_CREATION=False
      - AIRFLOW__API__AUTH_BACKENDS=airflow.api.auth.backend.basic_auth
      - MYSQL_HOST=mysql
      - MYSQL_PORT=3306
      - MYSQL_USER=root
      - MYSQL_PASSWORD=${MYSQL_ROOT_PASSWORD:-rootpassword}
      - MYSQL_DATABASE=torroforairflow
      - AIRFLOW_DAG_SCHEDULE=0 * * * *
    volumes:
      - ../airflow:/opt/airflow
      - airflow_logs:/opt/airflow/logs
    depends_on:
      mysql:
        condition: service_healthy
    restart: unless-stopped

  airflow-scheduler:
    build:
      context: ../airflow
      dockerfile: ../docker/Dockerfile.airflow
    container_name: torro-airflow-scheduler
    command: scheduler
    environment:
      - AIRFLOW__CORE__EXECUTOR=LocalExecutor
      - AIRFLOW__DATABASE__SQL_ALCHEMY_CONN=mysql+pymysql://root:${MYSQL_ROOT_PASSWORD:-rootpassword}@mysql:3306/torroforairflow
      - AIRFLOW__CORE__FERNET_KEY=${AIRFLOW_FERNET_KEY:-}
      - AIRFLOW__CORE__DAGS_ARE_PAUSED_AT_CREATION=False
      - MYSQL_HOST=mysql
      - MYSQL_PORT=3306
      - MYSQL_USER=root
      - MYSQL_PASSWORD=${MYSQL_ROOT_PASSWORD:-rootpassword}
      - MYSQL_DATABASE=torroforairflow
      - AIRFLOW_DAG_SCHEDULE=0 * * * *
    volumes:
      - ../airflow:/opt/airflow
      - airflow_logs:/opt/airflow/logs
    depends_on:
      - mysql
      - airflow-webserver
    restart: unless-stopped

  frontend:
    build:
      context: ../frontend
      dockerfile: ../docker/Dockerfile.frontend
      args:
        # This is baked into the frontend build at image build-time (Vite).
        # For local Docker usage, backend is exposed on host port 8099.
        VITE_API_BASE_URL: ${VITE_API_BASE_URL:-http://localhost:8099}
    container_name: torro-frontend
    ports:
      - "5162:80"
    depends_on:
      - backend
    restart: unless-stopped

  oracle-db:
    image: gvenzl/oracle-xe:21-slim
    container_name: torro-oracle
    environment:
      - ORACLE_PASSWORD=Oracle123
      - ORACLE_DATABASE=ORCL
    ports:
      - "1521:1521"
      - "5500:5500"  # Oracle Enterprise Manager Express
    volumes:
      - oracle_data:/opt/oracle/oradata
    healthcheck:
      test: ["CMD", "sqlplus", "-S", "sys/Oracle123@localhost:1521/XE", "AS", "SYSDBA", "-c", "SELECT 1 FROM DUAL"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 120s
    restart: unless-stopped

volumes:
  mysql_data:
  airflow_logs:
  oracle_data:

